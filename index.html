<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Pri‚Äôs Planner ‚Äî Projects ‚Üí Weekly ‚Üí Calendar</title>
<style>
  :root{ --bg:#f6f9fe; --card:#ffffff; --ink:#1d2433; --muted:#5d6b85; --brand:#5a7cf7; --accent:#00b894; --warn:#ff8a65; --shadow:0 10px 25px rgba(25,50,150,.08); --radius:16px; }
  *{box-sizing:border-box} html,body{height:100%}
  body{ margin:0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial; color:var(--ink);
        background:linear-gradient(135deg,#f0f5ff,#f8fbff 35%,#eefaff 70%,#f6f9fe);}
  header{ background: radial-gradient(1200px 400px at 20% -10%, #c7d2fe, transparent 60%),
                      radial-gradient(1200px 400px at 90% -10%, #bae6fd, transparent 60%),
                      linear-gradient(90deg,#5668ff,#5ac8fa);
          color:white; padding:26px 18px 20px; position:sticky; top:0; z-index:5; box-shadow:var(--shadow);}
  .wrap{max-width:1100px;margin:0 auto}
  .title{display:flex; gap:14px; align-items:center; flex-wrap:wrap}
  .title h1{margin:0; font-size:clamp(22px,4vw,28px)}
  .pill{padding:6px 10px; border-radius:999px; background:#eef7ff; color:#173; font-weight:600; font-size:12px}
  .row{display:grid; gap:18px; padding:18px; grid-template-columns:1fr}
  @media (min-width:980px){.row{grid-template-columns:1.2fr 1fr}}
  .card{background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); padding:16px}
  .muted{color:var(--muted)}
  .toolbar{display:flex; gap:8px; flex-wrap:wrap}
  button,.btn{border:0; border-radius:12px; padding:10px 12px; cursor:pointer; font-weight:600; background:var(--brand); color:#fff; box-shadow:0 5px 14px rgba(90,124,247,.25)}
  .btn-ghost{background:#eef2ff; color:#3b4dff; box-shadow:none}
  .btn-accent{background:var(--accent)} .btn-warn{background:var(--warn)}
  input,textarea,select{width:100%; padding:10px 12px; border-radius:12px; border:1px solid #e6ebf5; background:#fbfcff; outline:none; font-size:14px}
  .grid-2{display:grid; grid-template-columns:1fr 1fr; gap:10px}
  .grid-3{display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px}
  .list{display:grid; gap:10px; margin:10px 0 0}
  .item{background:#f9fbff; border:1px solid #edf2ff; border-radius:14px; padding:12px; display:grid; gap:6px}
  .topline{display:flex; align-items:center; gap:8px; justify-content:space-between}
  .badge{padding:4px 8px; border-radius:999px; font-size:12px; font-weight:700; color:#1b3; background:linear-gradient(90deg,#e9fff7,#f2fffc); border:1px solid #d9fff3}
  .meta{font-size:12px; color:var(--muted); display:flex; gap:10px; flex-wrap:wrap}
  .actions{display:flex; gap:8px; flex-wrap:wrap}
  .kpis{display:grid; grid-template-columns:repeat(3,1fr); gap:10px}
  .kpi{background:#f7fafc; border:1px solid #eef3ff; border-radius:14px; padding:12px; text-align:center}
  .kpi strong{font-size:18px; display:block}
  .footer-note{font-size:12px; color:var(--muted); margin-top:8px}
  dialog{border:0; border-radius:16px; width:min(680px,92vw); box-shadow:var(--shadow); padding:0}
  dialog::backdrop{background:rgba(0,12,40,.35)}
  .modal-head{padding:14px 16px; background:#f3f6ff; border-bottom:1px solid #e8eeff; border-radius:16px 16px 0 0}
  .modal-body{padding:14px 16px}
  .modal-actions{display:flex; gap:8px; padding:0 16px 16px}
  .auth{margin-top:8px; display:flex; gap:8px; align-items:center; flex-wrap:wrap}
  .auth small{opacity:.95}
</style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="title">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M7 3h10a2 2 0 0 1 2 2v2H5V5a2 2 0 0 1 2-2Zm12 6H5v8a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V9Z" stroke="#fff" stroke-width="1.6" stroke-linejoin="round"/><path d="M8 2v3M16 2v3" stroke="#fff" stroke-width="1.6" stroke-linecap="round"/></svg>
        <h1>Pri‚Äôs Planner</h1>
        <span class="pill">Monthly projects ‚Üí Weekly priorities ‚Üí Calendar</span>
      </div>
      <p class="muted" style="margin:6px 0 0">Local-first planner with optional Google sign-in sync. Create Calendar events and keep links attached to tasks.</p>

      <div class="toolbar" style="margin-top:10px">
        <button class="btn-accent" onclick="document.getElementById('p-name').focus()">Add Project</button>
        <button class="btn-ghost" onclick="document.getElementById('settingsDialog').showModal()">‚öôÔ∏è Settings</button>
      </div>

      <!-- INLINE onclick so it always works -->
      <div class="auth">
        <button class="btn-ghost" id="btn-signin"  onclick="trySignIn()">Sign in with Google</button>
        <button class="btn-ghost" id="btn-signout" style="display:none" onclick="trySignOut()">Sign out</button>
        <small id="auth-status">Not signed in</small>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div class="row">
      <!-- LEFT: Add / Projects -->
      <section class="card">
        <h2>‚ûï Add Project</h2>
        <div class="grid-2">
          <input id="p-name" placeholder="Project name"/>
          <input id="p-deadline" type="date" />
        </div>
        <div class="grid-3" style="margin-top:10px">
          <select id="p-stage"><option>Ideation</option><option selected>In Progress</option><option>Review</option><option>Final</option></select>
          <select id="p-priority"><option>P0</option><option selected>P1</option><option>P2</option></select>
          <input id="p-link" placeholder="Link (Drive/Figma/Doc)" />
        </div>
        <textarea id="p-notes" rows="3" style="margin-top:10px" placeholder="Notes (short)"></textarea>
        <div class="toolbar" style="margin-top:10px">
          <button onclick="addProject()">Add</button>
        </div>

        <div style="margin-top:16px">
          <div class="kpis">
            <div class="kpi"><strong id="kpi-total">0</strong><span class="muted">Total projects</span></div>
            <div class="kpi"><strong id="kpi-weekly">0</strong><span class="muted">Weekly items</span></div>
            <div class="kpi"><strong id="kpi-due">0</strong><span class="muted">Due this week</span></div>
          </div>
        </div>

        <h2 style="margin-top:16px">üìÅ Projects</h2>
        <div id="projects" class="list"></div>
        <p class="footer-note">Use ‚ÄúAdd to Weekly‚Äù to push a project into this week‚Äôs list.</p>
      </section>

      <!-- RIGHT: Weekly -->
      <section class="card">
        <h2>üìå This Week‚Äôs Priorities</h2>
        <div class="toolbar" style="margin-bottom:10px">
          <button class="btn-accent" onclick="quickAddWeekly()">Quick Add</button>
          <button class="btn-ghost" onclick="clearDone()">Clear Done</button>
        </div>
        <div id="weekly" class="list"></div>
        <p class="footer-note">Use **Google Calendar** to open a pre-filled event, or **.ics** for a downloadable file.</p>
      </section>
    </div>
  </main>

  <!-- Restore dialog -->
  <dialog id="importDialog">
    <div class="modal-head"><strong>Restore from backup</strong></div>
    <div class="modal-body">
      <textarea id="importText" rows="12" style="width:100%; font-family: ui-monospace, Menlo, monospace" placeholder='Paste backup text here'></textarea>
    </div>
    <div class="modal-actions">
      <button class="btn-accent" onclick="confirmImport()">Restore</button>
      <button class="btn-ghost" onclick="document.getElementById('importDialog').close()">Cancel</button>
    </div>
  </dialog>

  <!-- Settings dialog -->
  <dialog id="settingsDialog">
    <div class="modal-head"><strong>Settings</strong></div>
    <div class="modal-body" style="display:grid; gap:10px">
      <button class="btn-ghost" onclick="backupData()">Backup data</button>
      <button class="btn-ghost" onclick="document.getElementById('importDialog').showModal()">Restore from backup</button>
      <button class="btn-ghost" onclick="resetAll()">Reset everything</button>
      <small class="muted">Backups are simple text you can save anywhere.</small>
    </div>
    <div class="modal-actions">
      <button class="btn-accent" onclick="document.getElementById('settingsDialog').close()">Close</button>
    </div>
  </dialog>

<script>
/* ===== Core Planner (local + UI) ===== */
const storeKey = "pri_planner_v3";
let db = load() || { projects: [], weekly: [] };
let currentUser = null;      // set after Firebase auth

function uid(){ return Math.random().toString(36).slice(2, 9); }
function save(localOnly=false){
  localStorage.setItem(storeKey, JSON.stringify(db));
  render();
  if(currentUser && !localOnly && window.scheduleCloudSave){ scheduleCloudSave(); }
}
function load(){ try{ return JSON.parse(localStorage.getItem(storeKey)); }catch(e){ return null; } }
function fmtDate(d){ if(!d) return "No date"; try{ const dt=new Date(d); return dt.toLocaleDateString(undefined,{day:"2-digit",month:"short",year:"numeric"});}catch(e){return d;} }
function within7Days(dateStr){ if(!dateStr) return false; const now=new Date(); const d=new Date(dateStr); const diff=(d-now)/(1000*60*60*24); return diff<=7 && diff>=-1; }
function isoInDays(n){ const dt=new Date(); dt.setDate(dt.getDate()+n); return dt.toISOString().slice(0,10); }

function render(){
  document.getElementById("kpi-total").textContent = db.projects.length;
  document.getElementById("kpi-weekly").textContent = db.weekly.length;
  document.getElementById("kpi-due").textContent = db.weekly.filter(w => within7Days(w.due) && !w.done).length;

  // Projects
  const projEl = document.getElementById("projects");
  projEl.innerHTML = "";
  const prioRank = {P0:0, P1:1, P2:2, P3:3};
  [...db.projects].sort((a,b) => {
    const pr = (prioRank[a.priority] ?? 9) - (prioRank[b.priority] ?? 9);
    const dr = new Date(a.deadline||"2100-01-01") - new Date(b.deadline||"2100-01-01");
    return pr || dr;
  }).forEach(p => {
    const item = document.createElement("div");
    item.className = "item";
    item.innerHTML = `
      <div class="topline">
        <div><strong>${escapeHTML(p.name)}</strong></div>
        <span class="badge">${escapeHTML(p.priority||"P2")}</span>
      </div>
      <div class="meta">
        <span>Stage: <b>${escapeHTML(p.stage||"‚Äî")}</b></span>
        <span>Deadline: <b>${fmtDate(p.deadline)}</b></span>
        ${p.link ? `<span>üîó <a href="${escapeAttr(p.link)}" target="_blank">link</a></span>` : ""}
      </div>
      ${p.notes ? `<div class="muted">${escapeHTML(p.notes)}</div>` : ""}
      <div class="actions">
        <button class="btn-accent" onclick='addToWeekly("${p.id}")'>Add to Weekly</button>
        <button class="btn-ghost"  onclick='editProject("${p.id}")'>Edit</button>
        <button class="btn-warn"   onclick='deleteProject("${p.id}")'>Delete</button>
      </div>`;
    projEl.appendChild(item);
  });

  // Weekly
  const wEl = document.getElementById("weekly");
  wEl.innerHTML = "";
  [...db.weekly].sort((a,b) => {
    const dd = (a.done===b.done)?0: (a.done?1:-1);
    const dr = new Date(a.due||"2100-01-01") - new Date(b.due||"2100-01-01");
    return dd || dr;
  }).forEach(w => {
    const item = document.createElement("div");
    item.className = "item";
    item.style.opacity = w.done ? .6 : 1;
    item.innerHTML = `
      <div class="topline">
        <div><strong>${escapeHTML(w.title)}</strong></div>
        ${within7Days(w.due) ? `<span class="badge">Due soon</span>` : ``}
      </div>
      <div class="meta">
        <span>Due: <b>${fmtDate(w.due)}</b></span>
        ${w.link ? `<span>üîó <a href="${escapeAttr(w.link)}" target="_blank">link</a></span>` : ""}
        ${w.projectId ? `<span class="pill">linked to project</span>` : ``}
      </div>
      ${w.notes ? `<div class="muted">${escapeHTML(w.notes)}</div>` : ""}
      <div class="actions">
        <button class="btn-ghost" onclick='openGoogleCal(${JSON.stringify(w)})'>Google Calendar</button>
        <button class="btn-accent" onclick='downloadICS(${JSON.stringify(w)})'>.ics</button>
        <button class="btn-ghost" onclick='toggleDone("${w.id}")'>${w.done ? "Mark Undone" : "Mark Done"}</button>
        <button class="btn-ghost" onclick='editWeekly("${w.id}")'>Edit</button>
        <button class="btn-warn"  onclick='deleteWeekly("${w.id}")'>Delete</button>
      </div>`;
    wEl.appendChild(item);
  });

  // Auth header state
  document.getElementById("auth-status").textContent = currentUser ? `Synced as ${currentUser.email}` : "Not signed in";
  document.getElementById("btn-signin").style.display  = currentUser ? "none" : "inline-block";
  document.getElementById("btn-signout").style.display = currentUser ? "inline-block" : "none";
}

/* CRUD: Projects / Weekly */
function addProject(){
  const name = val("p-name");
  if(!name) return alert("Project name is required");
  const project = {
    id: uid(),
    name,
    deadline: val("p-deadline"),
    stage: val("p-stage") || "In Progress",
    priority: val("p-priority") || "P2",
    notes: val("p-notes"),
    link: val("p-link")
  };
  db.projects.push(project);
  clearInputs("p-name","p-deadline","p-notes","p-link");
  save();
}
function addToWeekly(projectId){
  const p = db.projects.find(x => x.id===projectId);
  if(!p) return;
  db.weekly.push({ id:uid(), title:p.name, due:p.deadline||isoInDays(7), projectId:p.id, notes:p.notes, link:p.link, done:false });
  save();
}
function editProject(id){
  const p = db.projects.find(x => x.id===id);
  if(!p) return;
  const name = prompt("Project name", p.name) ?? p.name;
  const deadline = prompt("Deadline (YYYY-MM-DD)", p.deadline||"") ?? p.deadline;
  const stage = prompt("Stage (Ideation/In Progress/Review/Final)", p.stage||"") ?? p.stage;
  const priority = prompt("Priority (P0/P1/P2)", p.priority||"P2") ?? p.priority;
  const link = prompt("Link", p.link||"") ?? p.link;
  const notes = prompt("Notes", p.notes||"") ?? p.notes;
  Object.assign(p, {name, deadline, stage, priority, link, notes});
  save();
}
function deleteProject(id){
  if(!confirm("Delete this project?")) return;
  db.projects = db.projects.filter(x => x.id!==id);
  db.weekly = db.weekly.map(w => w.projectId===id ? {...w, projectId:null} : w);
  save();
}
function quickAddWeekly(){
  const title = prompt("Weekly task title");
  if(!title) return;
  db.weekly.push({ id:uid(), title, due: isoInDays(3), notes:"", link:"", done:false });
  save();
}
function clearDone(){ db.weekly = db.weekly.filter(w => !w.done); save(); }
function editWeekly(id){
  const w = db.weekly.find(x => x.id===id);
  if(!w) return;
  const title = prompt("Title", w.title) ?? w.title;
  const due = prompt("Due (YYYY-MM-DD)", w.due||"") ?? w.due;
  const link = prompt("Link", w.link||"") ?? w.link;
  const notes = prompt("Notes", w.notes||"") ?? w.notes;
  Object.assign(w, {title, due, link, notes});
  save();
}
function deleteWeekly(id){ if(!confirm("Delete this weekly item?")) return; db.weekly = db.weekly.filter(x => x.id!==id); save(); }
function toggleDone(id){ const w = db.weekly.find(x => x.id===id); if(!w) return; w.done = !w.done; save(); }

/* Settings helpers */
function backupData(){
  const text = JSON.stringify(db, null, 2);
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([text], {type:"application/json"}));
  a.download = `planner-backup-${new Date().toISOString().slice(0,10)}.json`;
  a.click();
}
function confirmImport(){
  const txt = document.getElementById("importText").value;
  try{ const parsed = JSON.parse(txt); if(!parsed.projects || !parsed.weekly) throw new Error("Invalid format"); db = parsed; save(); document.getElementById("importDialog").close(); }
  catch(e){ alert("Could not restore. Check the backup text."); }
}
function resetAll(){ if(!confirm("This clears everything on this device.")) return; db = {projects:[], weekly:[]}; save(); }

/* Calendar helpers */
function downloadICS(w){
  const start = new Date(w.due || new Date()); start.setHours(10,0,0,0);
  const end = new Date(start); end.setHours(11);
  const toICS = dt => dt.toISOString().replace(/[-:]/g,"").split(".")[0] + "Z";
  const ics = [
    "BEGIN:VCALENDAR","VERSION:2.0","PRODID:-//Pri Planner//EN","CALSCALE:GREGORIAN","BEGIN:VEVENT",
    `UID:${w.id}@pri-planner`,`DTSTAMP:${toICS(new Date())}`,`DTSTART:${toICS(start)}`,`DTEND:${toICS(end)}`,
    `SUMMARY:${escapeICS(w.title)}`,`DESCRIPTION:${escapeICS((w.notes||"") + (w.link? `\n${w.link}`:""))}`,
    "END:VEVENT","END:VCALENDAR"].join("\r\n");
  const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([ics],{type:"text/calendar"}));
  a.download=(w.title||"task").replace(/\s+/g,"-").toLowerCase()+".ics"; a.click();
}
function openGoogleCal(w){
  const start=new Date(w.due||new Date()); start.setHours(10,0,0,0);
  const end=new Date(start); end.setHours(11);
  const fmt = d => d.toISOString().replace(/[-:]/g,"").split(".")[0]+"Z";
  const url = new URL("https://calendar.google.com/calendar/render");
  url.searchParams.set("action","TEMPLATE");
  url.searchParams.set("text", w.title||"Task");
  url.searchParams.set("dates", `${fmt(start)}/${fmt(end)}`);
  url.searchParams.set("details", `${w.notes||""}${w.link? "\n"+w.link:""}`);
  window.open(url.toString(), "_blank");
}

/* Small utils */
function val(id){ return document.getElementById(id).value.trim(); }
function clearInputs(...ids){ ids.forEach(i => document.getElementById(i).value=""); }
function escapeHTML(s){ return String(s??"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function escapeAttr(s){ return escapeHTML(s).replace(/"/g,'&quot;'); }
function escapeICS(s){ return String(s||"").replace(/[\n\r]/g,"\\n").replace(/,/g,"\\,").replace(/;/g,"\\;"); }

render();
</script>

<!-- ===== Google Sign-in & Cloud Sync (Firebase) ===== -->
<script>
  // global flags/functions used by inline onclick
  window.__useFirebase = false;
  function trySignIn(){
    if (!window.__useFirebase) { alert("Sign-in needs Firebase config.\nIf already added, hard refresh and try again."); return; }
    if (typeof window.__signin === "function") window.__signin();
  }
  function trySignOut(){ if (typeof window.__signout === "function") window.__signout(); }
</script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script>
/* Init Firebase safely */
try {
  const firebaseConfig = {
  apiKey: "AIzaSyDap9Hp_6VZFvY-26mqjFc_utNH42h9a5k",
  authDomain: "pri-planner.firebaseapp.com",
  projectId: "pri-planner",
  storageBucket: "pri-planner.appspot.com",
  messagingSenderId: "658123436645",
  appId: "1:658123436645:web:1e5ecf12b556c283140c8c"
};
  firebase.initializeApp(firebaseConfig);
  window.__useFirebase = true;
} catch(e) {
  console.warn("Firebase not configured; staying local-only.", e);
}

if (window.__useFirebase) {
  const auth = firebase.auth();
  const fs   = firebase.firestore();
  const docRefFor = (uid) => fs.collection("pri_planner").doc(uid);

  // Offline cache (ignore if not supported)
  fs.enablePersistence?.().catch(() => {});
  // Local session
  auth.useDeviceLanguage();
  auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch(console.warn);

  // Detect iframe/sandbox ‚Üí prefer redirect
  const inIframe = (() => { try { return window.self !== window.top; } catch { return true; } })();

  // Define globals used by buttons
  window.__signin = async () => {
    const provider = new firebase.auth.GoogleAuthProvider();
    try {
      if (inIframe) {
        await auth.signInWithRedirect(provider);
      } else {
        await auth.signInWithPopup(provider);
      }
    } catch (err) {
      console.error("Popup sign-in failed, falling back to redirect:", err?.code, err?.message);
      try { await auth.signInWithRedirect(provider); }
      catch (e2) {
        console.error("Redirect sign-in failed:", e2?.code, e2?.message);
        alert("Google sign-in couldn‚Äôt start.\n\n" +
              "‚Ä¢ Serve over http(s)\n" +
              "‚Ä¢ Add your domain in Firebase Auth ‚Üí Authorized domains\n" +
              "‚Ä¢ Enable Google provider in Firebase Auth\n\n" +
              `Error: ${e2?.code || "unknown"}`);
      }
    }
  };

  window.__signout = async () => {
    try { await auth.signOut(); }
    catch (e) { console.error("Sign-out error:", e?.code, e?.message); }
  };

  // Handle redirect results immediately (prevents flicker)
  auth.getRedirectResult()
    .then((result) => {
      if (result && result.user) {
        window.currentUser = result.user;
        document.getElementById("auth-status").textContent = `Synced as ${result.user.email}`;
        document.getElementById("btn-signin").style.display="none";
        document.getElementById("btn-signout").style.display="inline-block";
      }
    })
    .catch((e) => { console.error("getRedirectResult error:", e?.code, e?.message); });

  // Live auth state ‚Üí load/push Firestore right away + live listener
  let unsubscribe = null;
  auth.onAuthStateChanged(async (user) => {
    window.currentUser = user || null;

    // Clean up previous listener if any
    if (unsubscribe) { unsubscribe(); unsubscribe = null; }

    if (user) {
      document.getElementById("btn-signin").style.display = "none";
      document.getElementById("btn-signout").style.display = "inline-block";
      document.getElementById("auth-status").textContent = `Synced as ${user.email}`;

      const ref = docRefFor(user.uid);

      // Listen for remote changes (multi-device live sync)
      unsubscribe = ref.onSnapshot((snap) => {
        if (!snap.exists) return;
        db = snap.data();
        render();                 // render without triggering cloud push
        localStorage.setItem(storeKey, JSON.stringify(db));
      });

      // Ensure document exists on first sign-in
      const snap = await ref.get();
      if (!snap.exists) {
        await ref.set({ ...db, _lastUpdated: new Date().toISOString() });
      }
    } else {
      document.getElementById("btn-signin").style.display = "inline-block";
      document.getElementById("btn-signout").style.display = "none";
      document.getElementById("auth-status").textContent = "Not signed in";
    }
  });

  // Debounced cloud save
  window.scheduleCloudSave = function() {
    clearTimeout(window.__cloudTimer);
    window.__cloudTimer = setTimeout(async () => {
      if (window.currentUser) {
        try {
          const payload = { ...db, _lastUpdated: new Date().toISOString() };
          await docRefFor(window.currentUser.uid).set(payload, { merge: false });
        } catch (e) { console.error("Cloud save error:", e?.code, e?.message); }
      }
    }, 500);
  };
}
</script>
</body>
</html>
