<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Pri‚Äôs Planner ‚Äî Projects ‚Üí Weekly ‚Üí Calendar</title>
<style>
  :root{ --bg:#f6f9fe; --card:#ffffff; --ink:#1d2433; --muted:#5d6b85; --brand:#5a7cf7; --accent:#00b894; --warn:#ff8a65; --shadow:0 10px 25px rgba(25,50,150,.08); --radius:16px; }
  *{box-sizing:border-box} html,body{height:100%}
  body{ margin:0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial; color:var(--ink);
        background:linear-gradient(135deg,#f0f5ff,#f8fbff 35%,#eefaff 70%,#f6f9fe);}
  header{ background: linear-gradient(90deg,#5668ff,#5ac8fa);
          color:white; padding:26px 18px 20px; position:sticky; top:0; z-index:5; box-shadow:var(--shadow);}
  .wrap{max-width:1100px;margin:0 auto}
  .title{display:flex; gap:14px; align-items:center; flex-wrap:wrap}
  .title h1{margin:0; font-size:clamp(22px,4vw,28px)}
  .pill{padding:6px 10px; border-radius:999px; background:#eef7ff; color:#173; font-weight:600; font-size:12px}
  .row{display:grid; gap:18px; padding:18px; grid-template-columns:1fr}
  @media (min-width:980px){.row{grid-template-columns:1.2fr 1fr}}
  .card{background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); padding:16px}
  .muted{color:var(--muted)}
  .toolbar{display:flex; gap:8px; flex-wrap:wrap}
  button{border:0; border-radius:12px; padding:10px 12px; cursor:pointer; font-weight:600; background:var(--brand); color:#fff; box-shadow:0 5px 14px rgba(90,124,247,.25)}
  .btn-ghost{background:#eef2ff; color:#3b4dff; box-shadow:none}
  .btn-accent{background:var(--accent)} .btn-warn{background:var(--warn)}
  input,textarea,select{width:100%; padding:10px 12px; border-radius:12px; border:1px solid #e6ebf5; background:#fbfcff; outline:none; font-size:14px}
  .grid-2{display:grid; grid-template-columns:1fr 1fr; gap:10px}
  .grid-3{display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px}
  .list{display:grid; gap:10px; margin:10px 0 0}
  .item{background:#f9fbff; border:1px solid #edf2ff; border-radius:14px; padding:12px; display:grid; gap:6px}
  .topline{display:flex; align-items:center; gap:8px; justify-content:space-between}
  .badge{padding:4px 8px; border-radius:999px; font-size:12px; font-weight:700; color:#1b3; background:linear-gradient(90deg,#e9fff7,#f2fffc); border:1px solid #d9fff3}
  .meta{font-size:12px; color:var(--muted); display:flex; gap:10px; flex-wrap:wrap}
  .actions{display:flex; gap:8px; flex-wrap:wrap}
  .kpis{display:grid; grid-template-columns:repeat(3,1fr); gap:10px}
  .kpi{background:#f7fafc; border:1px solid #eef3ff; border-radius:14px; padding:12px; text-align:center}
  .kpi strong{font-size:18px; display:block}
  .footer-note{font-size:12px; color:var(--muted); margin-top:8px}
</style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="title">
        <h1>Pri‚Äôs Planner</h1>
        <span class="pill">Monthly projects ‚Üí Weekly priorities ‚Üí Calendar</span>
      </div>
      <p class="muted">Your planner, synced with Airtable ‚òÅÔ∏è</p>
      <div class="toolbar" style="margin-top:10px">
        <button class="btn-accent" onclick="document.getElementById('p-name').focus()">Add Project</button>
        <button class="btn-ghost" onclick="cloudLoad()">‚ü≥ Sync Now</button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div class="row">
      <!-- LEFT: Add / Projects -->
      <section class="card">
        <h2>‚ûï Add Project</h2>
        <div class="grid-2">
          <input id="p-name" placeholder="Project name"/>
          <input id="p-deadline" type="date" />
        </div>
        <div class="grid-3" style="margin-top:10px">
          <select id="p-stage"><option>Ideation</option><option selected>In Progress</option><option>Review</option><option>Final</option></select>
          <select id="p-priority"><option>P0</option><option selected>P1</option><option>P2</option></select>
          <input id="p-link" placeholder="Link (Drive/Figma/Doc)" />
        </div>
        <textarea id="p-notes" rows="3" style="margin-top:10px" placeholder="Notes (short)"></textarea>
        <div class="toolbar" style="margin-top:10px">
          <button onclick="addProject()">Add</button>
        </div>

        <div style="margin-top:16px">
          <div class="kpis">
            <div class="kpi"><strong id="kpi-total">0</strong><span class="muted">Total projects</span></div>
            <div class="kpi"><strong id="kpi-weekly">0</strong><span class="muted">Weekly items</span></div>
            <div class="kpi"><strong id="kpi-due">0</strong><span class="muted">Due this week</span></div>
          </div>
        </div>

        <h2 style="margin-top:16px">üìÅ Projects</h2>
        <div id="projects" class="list"></div>
        <p class="footer-note">Use ‚ÄúAdd to Weekly‚Äù to push a project into this week‚Äôs list.</p>
      </section>

      <!-- RIGHT: Weekly -->
      <section class="card">
        <h2>üìå This Week‚Äôs Priorities</h2>
        <div class="toolbar" style="margin-bottom:10px">
          <button class="btn-accent" onclick="quickAddWeekly()">Quick Add</button>
          <button class="btn-ghost" onclick="clearDone()">Clear Done</button>
        </div>
        <div id="weekly" class="list"></div>
        <p class="footer-note">Use **Google Calendar** to open a pre-filled event, or **.ics** for a downloadable file.</p>
      </section>
    </div>
  </main>

<script>
/* ========= Airtable CONFIG: paste your values ========= */
const AIRTABLE_TOKEN = "patyXlyESkLpAuBsY.ffaf735e412161a668e96fb43bc76ebb18f4457d3b9ff2b62fca59dc42adf4c5";   // pat******** from Developer Hub
const AIRTABLE_BASE  = "appuxirqdTb4YIqur";   // app******** from API docs
const AIRTABLE_TABLE = "Tasks";                      // table name in your base

/* ========= Local state ========= */
const storeKey = "pri_planner_v3";
let db = load() || { projects: [], weekly: [] };  // keep weekly local for now

function uid(){ return Math.random().toString(36).slice(2, 9); }
function save(){ localStorage.setItem(storeKey, JSON.stringify(db)); render(); debounceCloudSave(); }
function load(){ try{ return JSON.parse(localStorage.getItem(storeKey)); }catch(e){ return null; } }
function fmtDate(d){ if(!d) return "No date"; try{ return new Date(d).toLocaleDateString(undefined,{day:"2-digit",month:"short",year:"numeric"});}catch(e){return d;} }
function within7Days(dateStr){ if(!dateStr) return false; const now=new Date(); const d=new Date(dateStr); const diff=(d-now)/(1000*60*60*24); return diff<=7 && diff>=-1; }

/* ========= Render ========= */
function render(){
  document.getElementById("kpi-total").textContent = db.projects.length;
  document.getElementById("kpi-weekly").textContent = db.weekly.length;
  document.getElementById("kpi-due").textContent = db.weekly.filter(w => within7Days(w.due) && !w.done).length;

  const projEl = document.getElementById("projects");
  projEl.innerHTML = "";
  const prioRank = {P0:0, P1:1, P2:2, P3:3};
  [...db.projects].sort((a,b) => {
    const pr = (prioRank[a.priority] ?? 9) - (prioRank[b.priority] ?? 9);
    const dr = new Date(a.deadline||"2100-01-01") - new Date(b.deadline||"2100-01-01");
    return pr || dr;
  }).forEach(p => {
    const item = document.createElement("div");
    item.className = "item";
    item.innerHTML = `
      <div class="topline">
        <div><strong>${escapeHTML(p.title || p.name)}</strong></div>
        <span class="badge">${escapeHTML(p.priority||"P2")}</span>
      </div>
      <div class="meta">
        <span>Stage: <b>${escapeHTML(p.stage||"‚Äî")}</b></span>
        <span>Deadline: <b>${fmtDate(p.deadline)}</b></span>
        ${p.link ? `<span>üîó <a href="${escapeAttr(p.link)}" target="_blank">link</a></span>` : ""}
      </div>
      ${p.notes ? `<div class="muted">${escapeHTML(p.notes)}</div>` : ""}
      <div class="actions">
        <button class="btn-accent" onclick='addToWeekly("${p.id}")'>Add to Weekly</button>
        <button class="btn-ghost"  onclick='editProject("${p.id}")'>Edit</button>
        <button class="btn-warn"   onclick='deleteProject("${p.id}")'>Delete</button>
      </div>`;
    projEl.appendChild(item);
  });

  const wEl = document.getElementById("weekly");
  wEl.innerHTML = "";
  [...db.weekly].sort((a,b) => {
    const dd = (a.done===b.done)?0: (a.done?1:-1);
    const dr = new Date(a.due||"2100-01-01") - new Date(b.due||"2100-01-01");
    return dd || dr;
  }).forEach(w => {
    const item = document.createElement("div");
    item.className = "item";
    item.style.opacity = w.done ? 0.6 : 1;
    item.innerHTML = `
      <div class="topline">
        <div><strong>${escapeHTML(w.title)}</strong></div>
        ${within7Days(w.due) ? `<span class="badge">Due soon</span>` : ``}
      </div>
      <div class="meta">
        <span>Due: <b>${fmtDate(w.due)}</b></span>
        ${w.link ? `<span>üîó <a href="${escapeAttr(w.link)}" target="_blank">link</a></span>` : ""}
        ${w.projectId ? `<span class="pill">linked to project</span>` : ``}
      </div>
      ${w.notes ? `<div class="muted">${escapeHTML(w.notes)}</div>` : ""}
      <div class="actions">
        <button class="btn-ghost" onclick='openGoogleCal(${JSON.stringify(w)})'>Google Calendar</button>
        <button class="btn-accent" onclick='downloadICS(${JSON.stringify(w)})'>.ics</button>
        <button class="btn-ghost" onclick='toggleDone("${w.id}")'>${w.done ? "Mark Undone" : "Mark Done"}</button>
        <button class="btn-ghost" onclick='editWeekly("${w.id}")'>Edit</button>
        <button class="btn-warn"  onclick='deleteWeekly("${w.id}")'>Delete</button>
      </div>`;
    wEl.appendChild(item);
  });
}

/* ========= CRUD: Projects / Weekly ========= */
function addProject(){
  const project = {
    id: uid(),
    title: val("p-name"),
    deadline: val("p-deadline"),
    stage: val("p-stage") || "In Progress",
    priority: val("p-priority") || "P2",
    notes: val("p-notes"),
    link: val("p-link"),
    done: false
  };
  if(!project.title) return alert("Project name is required");
  db.projects.push(project);
  clearInputs("p-name","p-deadline","p-notes","p-link");
  save();
}
function editProject(id){
  const p = db.projects.find(x => x.id===id);
  if(!p) return;
  const title = prompt("Project name", p.title) ?? p.title;
  const deadline = prompt("Deadline (YYYY-MM-DD)", p.deadline||"") ?? p.deadline;
  const stage = prompt("Stage (Ideation/In Progress/Review/Final)", p.stage||"") ?? p.stage;
  const priority = prompt("Priority (P0/P1/P2)", p.priority||"P2") ?? p.priority;
  const link = prompt("Link", p.link||"") ?? p.link;
  const notes = prompt("Notes", p.notes||"") ?? p.notes;
  Object.assign(p, {title, deadline, stage, priority, link, notes});
  save();
}
function deleteProject(id){ db.projects = db.projects.filter(x => x.id!==id); save(); }

function addToWeekly(projectId){
  const p = db.projects.find(x => x.id===projectId);
  if(!p) return;
  db.weekly.push({ id:uid(), title:p.title, due:p.deadline, projectId:p.id, notes:p.notes, link:p.link, done:false });
  save();
}
function quickAddWeekly(){
  const title = prompt("Weekly task title");
  if(!title) return;
  const today = new Date().toISOString().slice(0,10);
  db.weekly.push({ id:uid(), title, due: today, notes:"", link:"", done:false });
  save();
}
function clearDone(){ db.weekly = db.weekly.filter(w => !w.done); save(); }
function editWeekly(id){
  const w = db.weekly.find(x => x.id===id);
  if(!w) return;
  const title = prompt("Title", w.title) ?? w.title;
  const due = prompt("Due (YYYY-MM-DD)", w.due||"") ?? w.due;
  const link = prompt("Link", w.link||"") ?? w.link;
  const notes = prompt("Notes", w.notes||"") ?? w.notes;
  Object.assign(w, {title, due, link, notes});
  save();
}
function deleteWeekly(id){ db.weekly = db.weekly.filter(x => x.id!==id); save(); }
function toggleDone(id){ const w = db.weekly.find(x => x.id===id); if(!w) return; w.done = !w.done; save(); }

/* ========= Airtable SYNC =========
   Strategy: Replace the Airtable table with current projects (no duplicates).
   - cloudLoad(): pulls all rows ‚Üí db.projects
   - cloudSave(): deletes all records, then re-creates from db.projects
   This is simple & reliable for small personal lists.
=================================== */
let cloudTimer=null;
function debounceCloudSave(){ clearTimeout(cloudTimer); cloudTimer=setTimeout(cloudSave, 400); }

async function cloudLoad(){
  if(!AIRTABLE_TOKEN || !AIRTABLE_BASE) { console.warn("Airtable keys missing"); return; }
  const out=[];
  let offset=null;
  try {
    do{
      const url = new URL(`https://api.airtable.com/v0/${AIRTABLE_BASE}/${encodeURIComponent(AIRTABLE_TABLE)}`);
      if(offset) url.searchParams.set("offset", offset);
      const res = await fetch(url, { headers:{Authorization:`Bearer ${AIRTABLE_TOKEN}`}});
      const data = await res.json();
      if(data?.records){
        for(const r of data.records){
          const f = r.fields || {};
          out.push({
            id: f.id || uid(),
            title: f.title || "",
            deadline: f.deadline || "",
            stage: f.stage || "In Progress",
            priority: f.priority || "P2",
            notes: f.notes || "",
            link: f.link || "",
            done: !!f.done
          });
        }
      }
      offset = data.offset;
    } while(offset);
    db.projects = out;
    save(); // re-render + localStorage (will also schedule a save, harmless)
  } catch(e){
    console.error("Airtable load failed:", e);
    alert("Could not load from Airtable. Check your token/base ID.");
  }
}

async function cloudSave(){
  if(!AIRTABLE_TOKEN || !AIRTABLE_BASE) { return; }
  try {
    // 1) Fetch existing records to delete
    let toDelete=[];
    let offset=null;
    do{
      const url = new URL(`https://api.airtable.com/v0/${AIRTABLE_BASE}/${encodeURIComponent(AIRTABLE_TABLE)}`);
      if(offset) url.searchParams.set("offset", offset);
      const res = await fetch(url, { headers:{Authorization:`Bearer ${AIRTABLE_TOKEN}`}});
      const data = await res.json();
      if(data?.records){ toDelete = toDelete.concat(data.records.map(r=>r.id)); }
      offset = data.offset;
    } while(offset);

    // Delete in batches of 10
    while(toDelete.length){
      const batch = toDelete.splice(0,10);
      await fetch(`https://api.airtable.com/v0/${AIRTABLE_BASE}/${encodeURIComponent(AIRTABLE_TABLE)}`,{
        method:"DELETE",
        headers:{Authorization:`Bearer ${AIRTABLE_TOKEN}`},
        body: new URLSearchParams(batch.map(id=>["records[]", id]))
      });
    }

    // 2) Create from local projects in batches of 10
    const records = db.projects.map(p=>({ fields:{
      id: p.id, title: p.title, deadline: p.deadline, stage: p.stage, priority: p.priority, notes: p.notes, link: p.link, done: !!p.done
    }}));
    let i=0;
    while(i < records.length){
      const batch = records.slice(i, i+10);
      await fetch(`https://api.airtable.com/v0/${AIRTABLE_BASE}/${encodeURIComponent(AIRTABLE_TABLE)}`,{
        method:"POST",
        headers:{Authorization:`Bearer ${AIRTABLE_TOKEN}`,"Content-Type":"application/json"},
        body: JSON.stringify({ records: batch })
      });
      i+=10;
    }
  } catch(e){
    console.error("Airtable save failed:", e);
  }
}

/* ========= Calendar helpers ========= */
function downloadICS(w){
  const start = new Date(w.due || new Date()); start.setHours(10,0,0,0);
  const end = new Date(start); end.setHours(11);
  const toICS = dt => dt.toISOString().replace(/[-:]/g,"").split(".")[0] + "Z";
  const ics = [
    "BEGIN:VCALENDAR","VERSION:2.0","PRODID:-//Pri Planner//EN","CALSCALE:GREGORIAN","BEGIN:VEVENT",
    `UID:${w.id}@pri-planner`,`DTSTAMP:${toICS(new Date())}`,`DTSTART:${toICS(start)}`,`DTEND:${toICS(end)}`,
    `SUMMARY:${escapeICS(w.title)}`,`DESCRIPTION:${escapeICS((w.notes||"") + (w.link? `\n${w.link}`:""))}`,
    "END:VEVENT","END:VCALENDAR"].join("\r\n");
  const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([ics],{type:"text/calendar"}));
  a.download=(w.title||"task").replace(/\s+/g,"-").toLowerCase()+".ics"; a.click();
}
function openGoogleCal(w){
  const start=new Date(w.due||new Date()); start.setHours(10,0,0,0);
  const end=new Date(start); end.setHours(11);
  const fmt = d => d.toISOString().replace(/[-:]/g,"").split(".")[0]+"Z";
  const url = new URL("https://calendar.google.com/calendar/render");
  url.searchParams.set("action","TEMPLATE");
  url.searchParams.set("text", w.title||"Task");
  url.searchParams.set("dates", `${fmt(start)}/${fmt(end)}`);
  url.searchParams.set("details", `${w.notes||""}${w.link? "\n"+w.link:""}`);
  window.open(url.toString(), "_blank");
}

/* ========= Small utils ========= */
function val(id){ return document.getElementById(id).value.trim(); }
function clearInputs(...ids){ ids.forEach(i => document.getElementById(i).value=""); }
function escapeHTML(s){ return String(s??"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function escapeAttr(s){ return escapeHTML(s).replace(/"/g,'&quot;'); }
function escapeICS(s){ return String(s||"").replace(/[\n\r]/g,"\\n").replace(/,/g,"\\,").replace(/;/g,"\\;"); }

render();
</script>
</body>
</html>
